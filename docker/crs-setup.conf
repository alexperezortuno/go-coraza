#########################################
# OWASP CRS CUSTOM PRODUCTION SETUP
# Optimized for Coraza + Reverse Proxy
#########################################

# -------------------------------
# 1) Paranoia Level (PL)
# -------------------------------
# PL1 = seguridad muy estable
# PL2 = recomendado para APIs y apps modernas
# PL3+ = solo si sabes lo que haces

SecAction \
 "id:900000,\
  phase:1,\
  pass,\
  nolog,\
  setvar:tx.blocking_paranoia_level=2"

# -------------------------------
# 2) Detection vs Blocking
# -------------------------------
# detection = PL para detectar sin bloquear
SecAction \
 "id:900001,\
  phase:1,\
  pass,\
  nolog,\
  setvar:tx.detection_paranoia_level=2"


# -------------------------------
# 3) Anomaly Thresholds
# -------------------------------
# =5 bloquea la mayoría de ataques reales
# =7 reduce falsos positivos iniciales
SecAction \
 "id:900110,\
  phase:1,\
  pass,\
  nolog,\
  setvar:tx.inbound_anomaly_score_threshold=5,\
  setvar:tx.outbound_anomaly_score_threshold=4"


# -------------------------------
# 4) Strict UTF-8 validation
# -------------------------------
# Bloquea payloads con encoding inválido
SecAction \
 "id:900950,\
  phase:1,\
  pass,\
  nolog,\
  setvar:tx.crs_validate_utf8_encoding=1"


# -------------------------------
# 5) Allowed Methods
# -------------------------------
# Ideal para tus apps
SecAction \
 "id:900200,\
  phase:1,\
  pass,\
  nolog,\
  setvar:tx.allowed_methods=GET HEAD POST PUT PATCH DELETE OPTIONS"


# -------------------------------
# 6) Allowed Content Types
# -------------------------------
# Optimizado para APIs JSON
SecAction \
 "id:900220,\
  phase:1,\
  pass,\
  nolog,\
  setvar:tx.allowed_request_content_type=|application/json| |application/x-www-form-urlencoded| |multipart/form-data| |text/plain|"


# -------------------------------
# 7) Allowed HTTP versions
# -------------------------------
SecAction \
 "id:900230,\
  phase:1,\
  pass,\
  nolog,\
  setvar:tx.allowed_http_versions=HTTP/1.1 HTTP/2"


# -------------------------------
# 8) Restricted Headers
# -------------------------------
SecAction \
 "id:900250,\
  phase:1,\
  pass,\
  nolog,\
  setvar:'tx.restricted_headers_basic=/proxy/ /lock-token/ /content-range/ /if/ /x-http-method-override/ /x-http-method/ /x-method-override/'"


# -------------------------------
# 9) Skip response body scanning
# -------------------------------
# PERFORMANCE BOOST (muy recomendado)
SecAction \
 "id:900500,\
  phase:1,\
  pass,\
  nolog,\
  setvar:tx.crs_skip_response_analysis=1"


# -------------------------------
# 10) Small hardening
# -------------------------------
# Límite razonable de argumentos
SecAction \
 "id:900300,\
  phase:1,\
  pass,\
  nolog,\
  setvar:tx.max_num_args=256"


# -------------------------------
# 11) Final setup marker
# -------------------------------
SecAction \
 "id:900990,\
  phase:1,\
  pass,\
  nolog,\
  setvar:tx.crs_setup_version=4220"
